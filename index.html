<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ricordi Eterni</title>
<style>
body { font-family:"Times New Roman", Times, serif; background:#0B3C91; text-align:center; margin:0; padding:20px; }
.box { background:#FFF; padding:25px; border-radius:14px; max-width:480px; margin:40px auto; box-shadow:0 6px 20px rgba(0,0,0,0.15);}
h1 { color:#0B3C91; margin-bottom:10px;}
button { margin-top:15px; padding:14px; width:100%; background:#0B3C91; border:none; color:#FFF; font-size:16px; border-radius:10px; cursor:pointer;}
button:hover { opacity:0.9;}
#mensaje { margin-top:15px; color:#0B3C91; }
input[type="file"] { display:none; }
</style>
</head>
<body>

<div class="box">
<h1>‚ú®RECUERDOS‚ú®</h1>
<p>üíç X & D üíç</p>

<input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
<input type="file" id="galleryInput" accept="image/*" multiple>

<button onclick="abrirCamara()">üì∏ Captura el momento</button>
<button onclick="abrirGaleria()">üñºÔ∏è Subir tu recuerdo</button>
<button onclick="subirFotos()">üíæ Guardar tu recuerdo</button>
<button onclick="verAlbum()">üìÇ Ver √°lbum</button>

<p id="mensaje">0 fotos seleccionadas</p>
</div>

<script>
const API_KEY = "0a5f721449bb9499e0f2049648e66abf"; // üîß tu API Key de ImgBB
const GITHUB_TOKEN = "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"; // üîß tu token
const REPO = "JoshGiosetti/album-boda"; // usuario/repositorio
const FILE_PATH = "fotos.json"; // ruta del JSON

let fotosSeleccionadas = [];

// Conectar inputs con funci√≥n
document.getElementById("cameraInput").addEventListener("change", seleccionarFotos);
document.getElementById("galleryInput").addEventListener("change", seleccionarFotos);

// Abrir inputs
function abrirCamara(){ document.getElementById("cameraInput").click(); }
function abrirGaleria(){ document.getElementById("galleryInput").click(); }

// Contador y selecci√≥n de fotos
function seleccionarFotos(e){
  fotosSeleccionadas = Array.from(e.target.files);
  document.getElementById("mensaje").innerText = fotosSeleccionadas.length + " foto(s) seleccionadas";
}

// Convertir archivo a Base64
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = err=>reject(err);
  });
}

// Comprimir imagen para subir m√°s r√°pido
function comprimirImagen(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const MAX_WIDTH = 1200;
        const MAX_HEIGHT = 900;
        let width = img.width;
        let height = img.height;

        if (width > MAX_WIDTH || height > MAX_HEIGHT) {
          const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
          width = width * ratio;
          height = height * ratio;
        }

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.7);
      };
    };
  });
}

// Subir fotos (paralelo y comprimido)
async function subirFotos(){
  if(fotosSeleccionadas.length === 0){
    document.getElementById("mensaje").innerText = "No seleccionaste fotos";
    return;
  }

  document.getElementById("mensaje").innerText = "Subiendo fotos...";

  const urlsSubidas = [];

  await Promise.all(fotosSeleccionadas.map(async (foto) => {
    const blob = await comprimirImagen(foto);
    const base64 = await toBase64(blob);
    const formData = new FormData();
    formData.append("image", base64.split(",")[1]);
    formData.append("key", API_KEY);

    const res = await fetch("https://api.imgbb.com/1/upload", { method:"POST", body:formData });
    const data = await res.json();
    urlsSubidas.push(data.data.url);
  }));

  await actualizarJSON(urlsSubidas);

  document.getElementById("mensaje").innerText = "‚ú® Tus recuerdos fueron guardados ‚ú®";
  fotosSeleccionadas = []; // Reiniciar contador
}

// Guardar URLs en GitHub
async function actualizarJSON(nuevasUrls){
  const urlAPI = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;
  
  const res = await fetch(urlAPI);
  const data = await res.json();
  const contenidoActual = JSON.parse(atob(data.content));

  const contenidoActualizado = contenidoActual.concat(nuevasUrls);

  await fetch(urlAPI, {
    method: "PUT",
    headers: {
      "Authorization": `token ${GITHUB_TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Agregar nuevas fotos",
      content: btoa(JSON.stringify(contenidoActualizado)),
      sha: data.sha
    })
  });
}

// Abrir √°lbum
function verAlbum(){
  window.open("album.html","_blank");
}

// Exponer funciones
window.subirFotos = subirFotos;
window.abrirCamara = abrirCamara;
window.abrirGaleria = abrirGaleria;
window.verAlbum = verAlbum;

</script>
</body>
</html>
